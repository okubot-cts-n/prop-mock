<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語学習ナビゲーション v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px 0;
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            color: #2c3e50;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }
        
        /* 診断画面のスタイル */
        .diagnosis-section {
            margin: 30px 0;
        }
        
        .question {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .skill-grid {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .skill-row {
            display: contents;
        }
        
        .skill-label {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #495057;
        }
        
        .skill-icon {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .difficulty-options {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .difficulty-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
            position: relative;
        }
        
        /* 展開可能なカード */
        .expandable-card {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .card-details {
            display: none;
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.5;
            animation: slideDown 0.3s ease;
        }
        
        .expandable-card.expanded .card-details {
            display: block;
        }
        
        .expandable-card.expanded {
            align-self: flex-start;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding-top: 0;
            }
            to {
                opacity: 1;
                max-height: 200px;
                padding-top: 15px;
            }
        }
        
        /* 主な課題部分の文字色を改善 */
        .card-details strong {
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .card-details {
            color: #ffffff !important;
        }
        
        /* ヘルプアイコン */
        .help-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .help-icon:hover {
            background: #667eea;
        }
        
        .difficulty-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .difficulty-btn.selected {
            border-color: #667eea !important;
            background: #667eea !important;
            color: white !important;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .difficulty-btn.selected:hover {
            background: #5a6fd8 !important;
            cursor: pointer;
        }
        
        .difficulty-btn:not(.selected):hover {
            cursor: pointer;
        }
        
        /* ステージ表示 */
        .stage-timeline {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
            position: relative;
        }
        
        .stage-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #dee2e6;
            z-index: 1;
        }
        
        .stage-item {
            background: #dee2e6;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 20px;
            position: relative;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .stage-item.current {
            background: #667eea;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        .stage-item.passed {
            background: #28a745;
        }
        
        /* 問題点と対策 */
        .issues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .issue-card {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 20px;
            border-radius: 8px;
        }
        
        .issue-title {
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .solution-card {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .solution-title {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }
        
        /* サービス推奨 */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .service-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .service-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .service-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .service-logo {
            font-size: 24px;
        }
        
        .service-price {
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
            margin-left: auto;
        }
        
        .service-toeic-level {
            color: #666;
            font-size: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .service-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .service-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .service-features {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .feature-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        /* 商品詳細ページ */
        .service-detail {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .service-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .service-logo {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 20px;
        }
        
        .service-info h2 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .service-price {
            color: #28a745;
            font-weight: bold;
            font-size: 18px;
        }
        
        .service-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .detail-section h3 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        .detail-list {
            list-style: none;
        }
        
        .detail-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .detail-list li:before {
            content: "✓";
            color: #28a745;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .cta-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        /* ボタン */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary:disabled:hover {
            background: #ccc;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-back {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-container {
            text-align: center;
            margin-top: 40px;
        }
        
        .navigation-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-tab:first-child {
            border-radius: 8px 0 0 8px;
        }
        
        .nav-tab:last-child {
            border-radius: 0 8px 8px 0;
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* TOEIC選択ボタン */
        .toeic-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .toeic-btn {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .toeic-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .toeic-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .toeic-score {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .toeic-level {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        .toeic-description {
            font-size: 12px;
            opacity: 0.7;
        }

        /* 課題・対策・アプローチのグリッド */
        .challenge-solution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .challenge-solution-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .challenge-solution-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .challenge-solution-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .challenge-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .challenge-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .challenge-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .challenge-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .solution-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .solution-section-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .solution-content {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .approach-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .approach-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 画面1: 開始画面 -->
        <div class="screen active" id="start-screen">
            <div class="header">
                <div class="logo">🎯 英語学習ナビ</div>
                <div class="subtitle">あなたに最適な英語学習サービスを見つけましょう</div>
            </div>
            
            <div style="text-align: center; margin: 50px 0;">
                <h2>3つの質問で最適なコースを診断</h2>
                <p style="color: #666; margin: 20px 0;">現在の英語レベルと学習目標から、あなたにぴったりのサービスをご提案します</p>
                <div style="margin: 40px 0;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                    <div style="color: #666;">診断時間：約2分</div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-primary" onclick="nextScreen('diagnosis-screen')">診断を開始する</button>
            </div>
        </div>
        
        <!-- 画面2: 診断画面 -->
        <div class="screen" id="diagnosis-screen">
            <div class="header">
                <div class="logo">レベル診断</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 25%"></div>
                </div>
            </div>
            
            <div class="diagnosis-section">
                <div class="question">まず、あなたの現在のTOEICレベルを教えてください</div>
                
                <div class="toeic-options">
                    <div class="toeic-btn" onclick="selectTOEIC(this, 'basic')">
                        <div class="toeic-score">300-600点</div>
                        <div class="toeic-level">基礎レベル</div>
                        <div class="toeic-description">基本的な文法や語彙を学習中</div>
                    </div>
                    <div class="toeic-btn" onclick="selectTOEIC(this, 'intermediate')">
                        <div class="toeic-score">600-750点</div>
                        <div class="toeic-level">中級レベル</div>
                        <div class="toeic-description">日常的な英語は理解できる</div>
                    </div>
                    <div class="toeic-btn" onclick="selectTOEIC(this, 'advanced')">
                        <div class="toeic-score">750点以上</div>
                        <div class="toeic-level">上級レベル</div>
                        <div class="toeic-description">ビジネス英語も理解できる</div>
                    </div>
                    <div class="toeic-btn" onclick="selectTOEIC(this, 'unknown')">
                        <div class="toeic-score">未受験</div>
                        <div class="toeic-level">レベル不明</div>
                        <div class="toeic-description">TOEICを受けたことがない</div>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-back" onclick="prevScreen('start-screen')">戻る</button>
                <button class="btn btn-primary" id="toeic-next-btn" onclick="nextScreen('skills-diagnosis')" disabled>次へ</button>
            </div>
        </div>
        
        <!-- 画面2.5: スキル診断画面 -->
        <div class="screen" id="skills-diagnosis">
            <div class="header">
                <div class="logo">スキル診断</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 50%"></div>
                </div>
            </div>
            
            <div class="diagnosis-section">
                <div class="question">現在の英語スキルについて教えてください</div>
                
                <div class="skill-grid">
                    <div class="skill-label">
                        <span class="skill-icon">🎧</span> 音声
                    </div>
                    <div class="difficulty-options">
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'sound', 'basic')" data-skill="sound" data-level="basic">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            基本的なルールが<br>わからない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                発音記号が読めない、子音・母音の区別がつかない、アクセントの位置がわからない
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                フォニックス学習、発音記号学習、音声認識練習
                        </div>
                        </div>
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'sound', 'intermediate')" data-skill="sound" data-level="intermediate">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            音が聞き分けられない<br>音が回らない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                L/Rの区別ができない、TH音が発音できない、単語レベルでの発音が不正確
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                音声認識訓練、発音矯正、リスニング強化
                        </div>
                        </div>
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'sound', 'advanced')" data-skill="sound" data-level="advanced">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            スピードについていけない<br>長くなると保持できない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                ネイティブの会話についていけない、長い説明を覚えていられない、音声情報の処理が追いつかない
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                高速リスニング訓練、音声記憶トレーニング、実践的会話練習
                            </div>
                        </div>
                    </div>
                    
                    <div class="skill-label">
                        <span class="skill-icon">📝</span> 文章
                    </div>
                    <div class="difficulty-options">
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'text', 'basic')" data-skill="text" data-level="basic">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            基本的な文のルール<br>（文法）がわからない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                時制の概念がわからない、語順が理解できない、品詞の区別ができない
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                基礎文法学習、パターン練習、構文理解トレーニング
                        </div>
                        </div>
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'text', 'intermediate')" data-skill="text" data-level="intermediate">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            文章で理解できない<br>文を組み立てられない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                長い文が読めない、正しい文が作れない、文脈が理解できない
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                読解練習、英作文訓練、文構造分析
                        </div>
                        </div>
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'text', 'advanced')" data-skill="text" data-level="advanced">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            情報量が多くなると<br>理解できない/話せない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                長文読解が困難、複雑な議論ができない、情報整理ができない
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                情報処理能力向上、論理的思考訓練、高度な読解・表現練習
                            </div>
                        </div>
                    </div>
                    
                    <div class="skill-label">
                        <span class="skill-icon">📖</span> 語彙
                    </div>
                    <div class="difficulty-options">
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'vocabulary', 'basic')" data-skill="vocabulary" data-level="basic">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            基本的な単語が<br>わからない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                高頻出単語がわからない、基本的な動詞・名詞が不明、単語の意味が曖昧
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                基本語彙学習、頻出単語暗記、語彙定着練習
                        </div>
                        </div>
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'vocabulary', 'intermediate')" data-skill="vocabulary" data-level="intermediate">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            とっさに簡単な<br>単語が出てこない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                会話で単語が出てこない、理解はできるが使えない、語彙の活用ができない
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                語彙瞬発力訓練、実践的語彙練習、語彙活用トレーニング
                        </div>
                        </div>
                        <div class="difficulty-btn expandable-card" onclick="selectDifficulty(this, 'vocabulary', 'advanced')" data-skill="vocabulary" data-level="advanced">
                            <div class="help-icon" onclick="event.stopPropagation(); toggleCardDetails(this.parentElement)" title="詳細を表示">i</div>
                            文脈に応じた表現の<br>使い分けができない
                            <div class="card-details">
                                <strong>🎯 主な課題：</strong><br>
                                フォーマル・カジュアルの区別ができない、同義語の使い分けができない、ニュアンスが伝わらない
                                <br><br>
                                <strong>📝 対策アプローチ：</strong><br>
                                文脈別語彙学習、表現力強化訓練、高度な語彙運用練習
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-back" onclick="prevScreen('diagnosis-screen')">戻る</button>
                <button class="btn btn-primary" id="skills-next-btn" onclick="nextScreen('level-result')" disabled>次へ</button>
            </div>
        </div>
        
        <!-- 画面3: レベル判定結果 -->
        <div class="screen" id="level-result">
            <div class="header">
                <div class="logo">あなたのレベル診断結果</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 66%"></div>
                </div>
            </div>
            
            <div class="stage-timeline" id="stage-timeline">
                <div class="stage-line"></div>
                <div class="stage-item" data-level="A1">A1</div>
                <div class="stage-item" data-level="A2">A2</div>
                <div class="stage-item" data-level="B1">B1</div>
                <div class="stage-item" data-level="B2">B2</div>
                <div class="stage-item" data-level="C1">C1</div>
                <div class="stage-item" data-level="C2">C2</div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #667eea;">あなたの現在レベル：<span id="user-level">A2</span></h2>
                <p style="color: #666;" id="level-description">基礎語彙がある程度理解できるレベル（TOEIC 500-600）</p>
            </div>
            
            <div style="margin: 20px 0;">
                <h3 style="color: #333; margin-bottom: 15px;">📋 あなたの主な課題</h3>
                <ul id="user-issues" style="background: #f8f9ff; padding: 20px; border-radius: 8px; color: #333;">
                    <!-- 課題リストが動的に表示される -->
                    </ul>
            </div>
            
            <div class="challenge-solution-grid" id="challenge-solution-grid">
                <!-- 課題・対策・アプローチがセットで表示される -->
            </div>
            
            <div class="btn-container">
                <button class="btn btn-back" onclick="prevScreen('diagnosis-screen')">戻る</button>
                <button class="btn btn-primary" onclick="showServices()">サービスを見る</button>
            </div>
        </div>
        
        <!-- 画面4: サービス推奨 -->
        <div class="screen" id="service-recommendation">
            <div class="header">
                <div class="logo">あなたにおすすめのサービス</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 id="recommendation-title">学習プラン</h2>
                <p style="color: #666;" id="recommendation-subtitle">あなたのレベルに合わせた最適なサービスをご提案</p>
            </div>
            
            <div class="services-grid" id="services-container">
                <!-- サービスカードは動的に生成 -->
            </div>
            
            <div class="btn-container">
                <button class="btn btn-back" onclick="prevScreen('level-result')">戻る</button>
                <button class="btn btn-primary" onclick="nextScreen('start-screen')">最初に戻る</button>
            </div>
        </div>
        
        <!-- 商品詳細ページ -->
        <div class="screen" id="service-detail">
            <div class="header">
                <div class="logo">サービス詳細</div>
            </div>
            
            <div class="service-detail" id="service-detail-content">
                <!-- 詳細内容は動的に生成 -->
            </div>
            
            <div class="btn-container">
                <button class="btn btn-back" onclick="prevScreen('service-recommendation')">戻る</button>
                <button class="btn btn-primary" onclick="visitService()">公式サイトへ</button>
            </div>
        </div>
    </div>
    
    <script>
        // ユーザーの選択を保存
        let userSelections = {
            toeic: null
        };

        // 新しいデータ構造から選択されたスキルを取得するヘルパー関数
        function getSelectedSkills() {
            const skills = {sound: [], text: [], vocabulary: []};
            
            Object.keys(userSelections).forEach(key => {
                if (key.includes('_') && userSelections[key] && userSelections[key].skill) {
                    const skillData = userSelections[key];
                    skills[skillData.skill].push(skillData.level);
                }
            });
            
            return skills;
        }

        // 特定のスキルで選択されているレベルを取得
        function getSkillLevels(skillName) {
            const skills = getSelectedSkills();
            return skills[skillName] || [];
        }

        // スキルが選択されているかチェック
        function hasSkillSelection(skillName, level = null) {
            const levels = getSkillLevels(skillName);
            if (level) {
                return levels.includes(level);
            }
            return levels.length > 0;
        }
        
        // 画面遷移関数
        function nextScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // スキル診断画面から次に進む場合の処理
            if (screenId === 'level-result') {
                updateChallengeSolutionCards();
                updateUserIssues();
            }
        }

        // 前の画面に戻る関数
        function prevScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // サービス推薦画面への遷移
        function showServices() {
            nextScreen('service-recommendation');
            displayServices();
            updateRecommendationTitle();
        }

        // 対策タブの表示
        function showSolution(type) {
            nextScreen('solution');
            showSolutionTabs();
        }

        // サービス表示関数
        function displayServices() {
            console.log('🎯 displayServices called');
            console.log('Current userSelections:', userSelections);
            
            const selectedServices = getFilteredServices();
            console.log('🔍 Filtered services:', selectedServices);
            console.log('📊 Service count:', selectedServices.length);
            
            updateRecommendationTitle();
            const container = document.getElementById('services-container');
            
            if (!container) {
                console.error('❌ services-container element not found!');
                return;
            }
            
            container.innerHTML = '';

            if (selectedServices.length === 0) {
                console.log('⚠️ No services found, showing default message');
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">課題を選択してからサービスを表示します</div>';
                return;
            }
            
            console.log('✅ Displaying services:', selectedServices.map(s => s.name));

            selectedServices.forEach((service, index) => {
                const card = document.createElement('div');
                card.className = 'service-card';
                card.onclick = () => showServiceDetail(service);

                const features = [
                    ...service.tags.specialties,
                    service.tags.learningStyle === 'self-study' ? '自主学習' :
                    service.tags.learningStyle === 'instructor-led' ? '講師付き' :
                    service.tags.learningStyle === 'ai-learning' ? 'AI学習' :
                    service.tags.learningStyle === 'coaching' ? 'コーチング' : '学習サポート'
                ];

                card.innerHTML = `
                    <div class="service-header">
                        <span class="service-logo">${service.logo}</span>
                        <div class="service-name">${service.name}</div>
                        <div class="service-price">${service.price}</div>
                    </div>
                    <div class="service-features">
                        ${features.slice(0, 3).map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                    </div>
                    <div class="service-toeic-level">
                        対応レベル: ${service.tags.toeicLevels.join(', ')}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // スキル診断の選択機能
        function selectDifficulty(element, skill, level) {
            console.log('🔥 selectDifficulty called:', skill, level);
            console.log('Element classes before:', element.className);
            console.log('Current userSelections before:', userSelections);
            
            // 既に選択されている場合は選択を解除
            if (element.classList.contains('selected')) {
                console.log('🔴 Element is selected, deselecting...');
                element.classList.remove('selected');
                delete userSelections[skill + '_' + level];
                console.log('🔴 Deselected:', skill, level);
                
                // 詳細が展開されている場合は閉じる
                const cardDetails = element.querySelector('.card-details');
                if (cardDetails && cardDetails.style.display !== 'none') {
                    cardDetails.style.display = 'none';
                    element.classList.remove('expanded');
                }
            } else {
                console.log('🔵 Element is not selected, selecting...');
                
                // 縦横関係なく自由選択 - 他の選択を解除しない
                console.log('🔍 Free selection mode - no restrictions');
                
                // 新しい選択を追加
                element.classList.add('selected');
                userSelections[skill + '_' + level] = {skill: skill, level: level};
                console.log('🔵 Selected:', skill, level);
                
                // 詳細を展開
                const cardDetails = element.querySelector('.card-details');
                if (cardDetails) {
                    cardDetails.style.display = 'block';
                    element.classList.add('expanded');
                }
            }
            
            console.log('Element classes after:', element.className);
            console.log('Current userSelections after:', userSelections);
            
            // 全体の選択状況を確認
            const allSelected = document.querySelectorAll('.difficulty-btn.selected');
            console.log('📊 Total selected buttons:', allSelected.length);
            allSelected.forEach((btn, i) => {
                console.log(`  ${i+1}. ${btn.dataset.skill} - ${btn.dataset.level}`);
            });
            
            // 次へボタンの有効/無効を更新
            updateSkillsNextButton();
        }

        // カード詳細の展開・折りたたみ機能
        function toggleCardDetails(element) {
            const card = element.closest ? element.closest('.expandable-card') : element;
            const details = card.querySelector('.card-details');
            
            if (details) {
                if (details.style.display === 'none' || details.style.display === '') {
                    details.style.display = 'block';
                    card.classList.add('expanded');
                } else {
                    details.style.display = 'none';
                    card.classList.remove('expanded');
                }
            }
        }

        // TOEIC選択機能
        function selectTOEIC(element, level) {
            // 既に選択されている場合は選択を解除
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                userSelections.toeic = null;
            } else {
                // 他のボタンの選択を解除
                const siblings = element.parentElement.children;
                for (let sibling of siblings) {
                    sibling.classList.remove('selected');
                }
                
                // 新しい選択を追加
                element.classList.add('selected');
                userSelections.toeic = level;
            }
            
            // 次へボタンの有効/無効を更新
            updateTOEICNextButton();
        }
        
        function updateTOEICNextButton() {
            const nextBtn = document.getElementById('toeic-next-btn');
            
            if (userSelections.toeic) {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            } else {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            }
        }
        
        // 課題詳細データ
        const challengeDetails = {
            sound: {
                basic: {
                    title: "音声 - 基本的なルールがわからない",
                    description: "英語の音のルール（発音記号、音の変化、リズムなど）の基礎知識が不足している状態です。",
                    examples: [
                        "発音記号が読めない",
                        "子音と母音の区別ができない",
                        "単語のアクセントがわからない",
                        "リエゾン（音の連結）が理解できない",
                        "強勢とリズムがつかめない"
                    ]
                },
                intermediate: {
                    title: "音声 - 音が聞き分けられない・音が回らない",
                    description: "基本的な音のルールは理解しているが、実際の聞き取りや発話で困難を感じている状態です。",
                    examples: [
                        "LとRの区別ができない",
                        "THの音が出せない",
                        "早口になると聞き取れない",
                        "自分で発音しようとすると舌が回らない",
                        "ネイティブの発音と自分の発音が違う"
                    ]
                },
                advanced: {
                    title: "音声 - スピードについていけない・長くなると保持できない",
                    description: "個々の音は理解できるが、自然なスピードや長い文章になると処理が追いつかない状態です。",
                    examples: [
                        "映画やドラマの英語が早すぎて聞き取れない",
                        "長い文章の途中で内容を忘れてしまう",
                        "会議やプレゼンテーションについていけない",
                        "電話での会話が困難",
                        "複数人の会話に入れない"
                    ]
                }
            },
            text: {
                basic: {
                    title: "文章 - 基本的な文のルール（文法）がわからない",
                    description: "英語の基本的な文法構造や語順ルールが理解できていない状態です。",
                    examples: [
                        "主語・動詞・目的語の順番がわからない",
                        "時制（現在・過去・未来）が使い分けられない",
                        "疑問文・否定文の作り方がわからない",
                        "前置詞の使い方がわからない",
                        "単数・複数の概念が曖昧"
                    ]
                },
                intermediate: {
                    title: "文章 - 文章で理解できない・文を組み立てられない",
                    description: "基本文法は理解しているが、実際の文章理解や作文で困難を感じている状態です。",
                    examples: [
                        "長い文章の構造が把握できない",
                        "関係代名詞の文が理解できない",
                        "自分の言いたいことを英語で表現できない",
                        "文章を読むのに時間がかかりすぎる",
                        "複雑な文法構造が使えない"
                    ]
                },
                advanced: {
                    title: "文章 - 情報量が多くなると理解できない・話せない",
                    description: "基本的な文章は理解できるが、複雑で情報量の多い内容になると処理が困難な状態です。",
                    examples: [
                        "論文や専門文書が読めない",
                        "ビジネス文書の作成ができない",
                        "プレゼンテーションで論理的に話せない",
                        "ディスカッションで意見を整理して伝えられない",
                        "ニュアンスや含意が理解できない"
                    ]
                }
            },
            vocabulary: {
                basic: {
                    title: "語彙 - 基本的な単語がわからない",
                    description: "日常生活や基本的なコミュニケーションに必要な語彙が不足している状態です。",
                    examples: [
                        "中学レベルの基本単語がわからない",
                        "数字や曜日、月が英語で言えない",
                        "家族や職業の単語がわからない",
                        "基本的な動詞（eat, drink, go等）が使えない",
                        "色や形の単語がわからない"
                    ]
                },
                intermediate: {
                    title: "語彙 - とっさに簡単な単語が出てこない",
                    description: "語彙は知っているが、会話や作文で適切な単語を瞬時に思い出せない状態です。",
                    examples: [
                        "知っている単語なのに会話で出てこない",
                        "日本語では簡単に言えることが英語で表現できない",
                        "単語を思い出すのに時間がかかる",
                        "同じ単語ばかり使ってしまう",
                        "類義語の使い分けができない"
                    ]
                },
                advanced: {
                    title: "語彙 - 文脈に応じた表現の使い分けができない",
                    description: "豊富な語彙は持っているが、場面や文脈に応じた適切な表現選択ができない状態です。",
                    examples: [
                        "フォーマル・カジュアルの使い分けができない",
                        "ビジネス場面での適切な表現がわからない",
                        "文化的なニュアンスが理解できない",
                        "専門用語と一般用語の使い分けができない",
                        "相手に応じた敬語レベルの調整ができない"
                    ]
                }
            }
        };

        // カード詳細の展開・折りたたみ機能
        function toggleCardDetails(element) {
            const card = element.closest ? element.closest('.expandable-card') : element;
            const details = card.querySelector('.card-details');
            
            if (details) {
                if (details.style.display === 'none' || details.style.display === '') {
                    details.style.display = 'block';
                    card.classList.add('expanded');
                } else {
                    details.style.display = 'none';
                    card.classList.remove('expanded');
                }
            }
        }
        
        // 課題・対策・アプローチカードを更新
        function updateChallengeSolutionCards() {
            const container = document.getElementById('challenge-solution-grid');
            const challengeSolutions = [];
            
            // 選択された課題に基づいてカードを生成
            const selectedSkills = getSelectedSkills();
            
            if (selectedSkills.sound.length > 0) {
                selectedSkills.sound.forEach(level => {
                    challengeSolutions.push(createChallengeSolutionCard('sound', level));
                });
            }
            if (selectedSkills.text.length > 0) {
                selectedSkills.text.forEach(level => {
                    challengeSolutions.push(createChallengeSolutionCard('text', level));
                });
            }
            if (selectedSkills.vocabulary.length > 0) {
                selectedSkills.vocabulary.forEach(level => {
                    challengeSolutions.push(createChallengeSolutionCard('vocabulary', level));
                });
            }
            
            container.innerHTML = challengeSolutions.join('');
        }
        
        function createChallengeSolutionCard(skill, level) {
            const skillData = {
                sound: { icon: '🎧', name: '音声' },
                text: { icon: '📝', name: '文章' },
                vocabulary: { icon: '📖', name: '語彙' }
            };
            
            const challengeData = challengeDetails[skill][level];
            const solutions = getSolutionForChallenge(skill, level);
            
            return `
                <div class="challenge-solution-card" onclick="selectChallengeSolution('${skill}', '${level}')">
                    <div class="challenge-header">
                        <div class="challenge-icon">${skillData[skill].icon}</div>
                        <div class="challenge-title">${skillData[skill].name}の課題</div>
                    </div>
                    <div class="challenge-description">${challengeData.title.split(' - ')[1]}</div>
                    
                    <div class="solution-section">
                        <div class="solution-section-title">🎯 対策</div>
                        <div class="solution-content">${solutions.strategy}</div>
                    </div>
                    
                    <div class="solution-section">
                        <div class="solution-section-title">📚 アプローチ</div>
                        <div class="solution-content">${solutions.approach}</div>
                        <div class="approach-tags">
                            ${solutions.methods.map(method => `<span class="approach-tag">${method}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getSolutionForChallenge(skill, level) {
            const solutions = {
                sound: {
                    basic: {
                        strategy: "音のルールを基礎から学習し、発音の基本を身につける",
                        approach: "発音記号の学習、基本的な音の練習、アクセント・リズムの習得",
                        methods: ["発音記号学習", "音読練習", "基礎トレーニング"]
                    },
                    intermediate: {
                        strategy: "音を再現できる（発話できる）ことがゴール",
                        approach: "音読/シャドーイング（レベルに合わせた速さ）、発音矯正トレーニング",
                        methods: ["シャドーイング", "音読トレーニング", "発音矯正"]
                    },
                    advanced: {
                        strategy: "自然なスピードでの音声処理能力を向上させる",
                        approach: "高速音声への慣れ、長文リスニング、実践的な会話練習",
                        methods: ["高速シャドーイング", "実践会話", "長文リスニング"]
                    }
                },
                text: {
                    basic: {
                        strategy: "基本的な文法ルールを体系的に学習する",
                        approach: "中学・高校レベルの文法復習、基本文型の習得",
                        methods: ["基礎文法", "文型練習", "例文暗記"]
                    },
                    intermediate: {
                        strategy: "とにかく英語の文章をクイックに組むこと",
                        approach: "瞬間英作文、カランメソッドなど、英作文系エクササイズ",
                        methods: ["瞬間英作文", "カランメソッド", "文構造練習"]
                    },
                    advanced: {
                        strategy: "クイックに構造化すること",
                        approach: "文脈に合わせた表現の選定、長い文章の多聴多読",
                        methods: ["構造化練習", "多聴多読", "表現選定"]
                    }
                },
                vocabulary: {
                    basic: {
                        strategy: "基本語彙を着実に増やし、定着させる",
                        approach: "頻出単語の暗記、基本語彙の反復学習",
                        methods: ["基本語彙", "反復学習", "語彙テスト"]
                    },
                    intermediate: {
                        strategy: "語彙の瞬発力を向上させる",
                        approach: "語彙の使い分け練習、瞬発的な語彙想起トレーニング",
                        methods: ["語彙想起", "使い分け", "実践練習"]
                    },
                    advanced: {
                        strategy: "文脈に応じた適切な表現を選択できるようになる",
                        approach: "ニュアンスの理解、場面別表現の習得、実践的な使用練習",
                        methods: ["ニュアンス学習", "場面別表現", "実践使用"]
                    }
                }
            };
            
            return solutions[skill][level];
        }
        
        // 課題・対策カードの選択
        let selectedChallenge = null;
        
        function selectChallengeSolution(skill, level) {
            // 既存の選択を解除
            document.querySelectorAll('.challenge-solution-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 新しい選択を追加
            event.currentTarget.classList.add('selected');
            selectedChallenge = { skill, level };
        }
        
        // 🏷️ 新しいタグベースのサービスフィルタリング
        function getFilteredServices() {
            console.log('🏷️ タグベースフィルタリング開始');
            console.log('Current userSelections:', userSelections);
            
            // ユーザーの選択からTOEICレベルを決定
            const toeicLevel = getToeicLevelFromSelection();
            console.log('📊 Determined TOEIC level:', toeicLevel);
            
            // 選択されたスキルと難易度を取得
            const selectedSkills = [];
            const selectedDifficulties = [];
            
            const skillsData = getSelectedSkills();
            console.log('🎯 Skills data:', skillsData);
            
            if (skillsData.sound.length > 0) {
                selectedSkills.push('sound');
                selectedDifficulties.push(...skillsData.sound);
            }
            if (skillsData.text.length > 0) {
                selectedSkills.push('text');
                selectedDifficulties.push(...skillsData.text);
            }
            if (skillsData.vocabulary.length > 0) {
                selectedSkills.push('vocabulary');
                selectedDifficulties.push(...skillsData.vocabulary);
            }
            
            console.log('🎯 Selected skills:', selectedSkills);
            console.log('🎯 Selected difficulties:', selectedDifficulties);
            
            // 選択がない場合はデフォルトサービスを返す
            if (selectedSkills.length === 0) {
                console.log('⚠️ スキル選択なし、デフォルトサービスを表示');
                return allServices.slice(0, 6); // 最初の6つのサービス
            }
            
            console.log('🔍 Total services available:', allServices.length);
            allServices.forEach((service, i) => {
                console.log(`Service ${i+1}: ${service.name} - Skills: ${service.tags.skills}, Difficulties: ${service.tags.difficulties}, TOEIC: ${service.tags.toeicLevels}`);
            });
            
            console.log('Filtering criteria:', {
                toeicLevel,
                selectedSkills,
                selectedDifficulties
            });
            
            // サービスをフィルタリング
            const filteredServices = allServices.filter(service => {
                // TOEICレベルマッチ
                const toeicMatch = service.tags.toeicLevels.includes(toeicLevel);
                
                // スキルマッチ（選択されたスキルのいずれかに対応）
                const skillMatch = selectedSkills.some(skill => 
                    service.tags.skills.includes(skill)
                );
                
                // 難易度マッチ（選択された難易度のいずれかに対応）
                const difficultyMatch = selectedDifficulties.some(difficulty => 
                    service.tags.difficulties.includes(difficulty)
                );
                
                const matches = toeicMatch && skillMatch && difficultyMatch;
                
                if (matches) {
                    console.log(`✅ ${service.name} マッチ:`, {
                        toeic: toeicMatch,
                        skill: skillMatch,
                        difficulty: difficultyMatch
                    });
                }
                
                return matches;
            });
            
            console.log(`🎯 フィルタ結果: ${filteredServices.length}件のサービス`);
            return filteredServices;
        }
        
        // TOEICレベルを選択から決定
        function getToeicLevelFromSelection() {
            // 直接TOEICレベルが選択されている場合
            if (userSelections.toeic) {
                const toeicMapping = {
                    'basic': '300-600',
                    'intermediate': '600-750', 
                    'advanced': '750+'
                };
                return toeicMapping[userSelections.toeic] || '600-750';
            }
            
            // スキル選択から推定
            const skillsData = getSelectedSkills();
            const difficulties = [
                ...skillsData.sound,
                ...skillsData.text, 
                ...skillsData.vocabulary
            ].filter(d => d !== null && d !== undefined);
            
            if (difficulties.length === 0) return '600-750'; // デフォルト
            
            const basicCount = difficulties.filter(d => d === 'basic').length;
            const advancedCount = difficulties.filter(d => d === 'advanced').length;
            
            if (basicCount >= 2) return '300-600';
            if (advancedCount >= 2) return '750+';
            return '600-750';
        }
        
        // 📊 CSVから更新されたタグベースのサービスデータ
        const allServices = [
            {
                name: "スタディサプリ ENGLISH",
                price: "月額2,178円",
                logo: "📚",
                tags: {
                    toeicLevels: ["300-600"],
                    skills: ["sound", "text", "vocabulary"],
                    difficulties: ["basic"],
                    learningStyle: "self-study",
                    specialties: ["\u30b9\u30de\u30db\u5b66\u7fd2\u30fbAI\u5b66\u7fd2\u30fb\u9032\u6357\u7ba1\u7406"]
                },
                    details: {
                    "学習内容": ["基本単語学習", "基礎固め・発音練習", "基礎文法・読解"],
                    "特徴": ["スマホ学習・AI学習・進捗管理"]
                },
                url: "https://eigosapuri.jp/"
            },
            {
                name: "abceed",
                price: "月額1,650円",
                logo: "📱",
                tags: {
                    toeicLevels: ["300-600"],
                    skills: ["sound", "text", "vocabulary"],
                    difficulties: ["basic"],
                    learningStyle: "self-study",
                    specialties: ["AI\u4e88\u6e2c\u30b9\u30b3\u30a2\u30fb\u8c4a\u5bcc\u306a\u554f\u984c\u96c6"]
                },
                    details: {
                    "学習内容": ["基本単語学習", "基礎固め・発音練習", "基礎文法・読解"],
                    "特徴": ["AI予測スコア・豊富な問題集"]
                },
                url: "https://www.abceed.com/"
            },
            {
                name: "DMM英会話",
                price: "月額5,450円",
                    logo: "💬",
                tags: {
                    toeicLevels: ["300-600", "600-750"],
                    skills: ["sound", "text"],
                    difficulties: ["basic", "intermediate"],
                    learningStyle: "instructor-led",
                    specialties: ["\u591a\u56fd\u7c4d\u8b1b\u5e2b\u30fb24\u6642\u9593\u5bfe\u5fdc"]
                },
                    details: {
                    "学習内容": ["ビジネス英会話", "基礎文法・会話練習", "日常英会話", "発音練習・基礎会話"],
                    "特徴": ["多国籍講師・24時間対応"]
                },
                url: "https://eikaiwa.dmm.com/"
            },
            {
                name: "SHADOTEN",
                price: "月額21,780円",
                logo: "🎯",
                tags: {
                    toeicLevels: ["600-750", "750+"],
                    skills: ["sound"],
                    difficulties: ["advanced", "intermediate"],
                    learningStyle: "self-study",
                    specialties: ["\u30d7\u30ed\u6dfb\u524a\u30fb\u97f3\u58f0\u5206\u6790"]
                },
                    details: {
                    "学習内容": ["シャドーイング訓練"],
                    "特徴": ["プロ添削・音声分析"]
                },
                url: "https://www.shadoten.com/"
            },
            {
                name: "AI英会話 スピークバディ",
                price: "月額3,300円",
                logo: "🤖",
                tags: {
                    toeicLevels: ["300-600", "600-750"],
                    skills: ["vocabulary"],
                    difficulties: ["basic", "intermediate"],
                    learningStyle: "ai-learning",
                    specialties: ["24\u6642\u9593\u5229\u7528\u30fb\u6065\u305a\u304b\u3057\u304f\u306a\u3044"]
                },
                    details: {
                    "学習内容": ["語彙定着練習", "語彙活用練習"],
                    "特徴": ["24時間利用・恥ずかしくない"]
                },
                url: "https://www.speakbuddy.me/"
                },
                {
                    name: "Speak",
                price: "月額1,800円",
                logo: "🗣️",
                tags: {
                    toeicLevels: ["600-750", "750+"],
                    skills: ["vocabulary"],
                    difficulties: ["advanced", "intermediate"],
                    learningStyle: "ai-learning",
                    specialties: ["\u9ad8\u7cbe\u5ea6AI\u30fb\u5b9f\u8df5\u7684"]
                },
                    details: {
                    "学習内容": ["表現力向上"],
                    "特徴": ["高精度AI・実践的"]
                },
                url: "https://www.speak.com/"
            },
            {
                name: "SUPIFUL",
                price: "月額4,378円",
                logo: "✍️",
                tags: {
                    toeicLevels: ["600-750", "750+"],
                    skills: ["text", "vocabulary"],
                    difficulties: ["advanced", "intermediate"],
                    learningStyle: "self-study",
                    specialties: ["AI\u6dfb\u524a\u30fb\u30a2\u30a6\u30c8\u30d7\u30c3\u30c8\u91cd\u8996"]
                },
                    details: {
                    "学習内容": ["英作文練習・スピーキング訓練", "表現力向上"],
                    "特徴": ["AI添削・アウトプット重視"]
                },
                url: "https://supiful.com/"
            },
            {
                name: "QQ English",
                price: "月額2,980円",
                logo: "⚡",
                tags: {
                    toeicLevels: ["600-750", "750+"],
                    skills: ["sound", "text"],
                    difficulties: ["advanced", "intermediate"],
                    learningStyle: "instructor-led",
                    specialties: ["\u9ad8\u901f\u5b66\u7fd2\u30fb\u96c6\u4e2d\u8a13\u7df4"]
                },
                    details: {
                    "学習内容": ["カランメソッド・4倍速学習", "瞬間英作文"],
                    "特徴": ["高速学習・集中訓練"]
                },
                url: "https://www.qqeng.com/"
                },
                {
                    name: "Bizmates",
                price: "月額13,200円",
                    logo: "💼",
                tags: {
                    toeicLevels: ["750+"],
                    skills: ["text", "vocabulary"],
                    difficulties: ["advanced"],
                    learningStyle: "instructor-led",
                    specialties: ["\u30d3\u30b8\u30cd\u30b9\u7279\u5316\u30fb\u5b9f\u52d9\u7d4c\u9a13\u8b1b\u5e2b"]
                },
                    details: {
                    "学習内容": ["ビジネス英会話・プレゼン練習", "ビジネス語彙・交渉スキル"],
                    "特徴": ["ビジネス特化・実務経験講師"]
                    },
                    url: "https://www.bizmates.jp/"
                },
                {
                name: "Native Camp",
                price: "月額6,480円",
                logo: "🌍",
                tags: {
                    toeicLevels: ["600-750", "750+"],
                    skills: ["text"],
                    difficulties: ["advanced", "intermediate"],
                    learningStyle: "self-study",
                    specialties: []
                },
                    details: {
                    "学習内容": ["カランメソッド・4倍速学習"],
                    "特徴": []
                },
                url: "https://nativecamp.net/"
            }
        ];
        
        function updateRecommendationTitle() {
            const level = determineUserLevel();
            const levelMap = {
                basic: { level: 'A1', nextLevel: 'A2' },
                intermediate: { level: 'A2', nextLevel: 'B1' },
                advanced: { level: 'B1', nextLevel: 'B2' }
            };
            
            const info = levelMap[level];
            const title = document.getElementById('recommendation-title');
            const subtitle = document.getElementById('recommendation-subtitle');
            
            title.textContent = `${info.level}レベル → ${info.nextLevel}レベルへの学習プラン`;
            
            // 選択された内容に基づいてサブタイトルを更新
            const selectedCategories = [];
            const skillsData = getSelectedSkills();
            
            if (hasSkillSelection('sound', 'basic')) selectedCategories.push('基礎対策');
            if (hasSkillSelection('sound', 'intermediate') || hasSkillSelection('sound', 'advanced')) selectedCategories.push('音の対策');
            if (hasSkillSelection('text', 'intermediate') || hasSkillSelection('text', 'advanced') || 
                hasSkillSelection('vocabulary', 'intermediate') || hasSkillSelection('vocabulary', 'advanced')) {
                selectedCategories.push('短い文章と語彙の対策');
            }
            if (hasSkillSelection('text', 'advanced') || hasSkillSelection('vocabulary', 'advanced')) {
                selectedCategories.push('長い文章と表現の対策');
            }
            
            if (selectedCategories.length > 0) {
                subtitle.textContent = selectedCategories.join(' ＋ ');
            } else {
                subtitle.textContent = '基礎対策';
            }
        }
        
        function getSelectedServices() {
            // 新しいタグベースシステムを使用
            return getFilteredServices();
        }
        
        function determineUserLevel() {
            // 選択されたレベルに基づいて判定
            const levels = Object.values(userSelections).filter(l => l !== null);
            
            if (levels.length === 0) return 'intermediate'; // デフォルト
            
            const basicCount = levels.filter(l => l === 'basic').length;
            const advancedCount = levels.filter(l => l === 'advanced').length;
            const intermediateCount = levels.filter(l => l === 'intermediate').length;
            
            // 最も多いレベルを返す
            if (basicCount >= intermediateCount && basicCount >= advancedCount) return 'basic';
            if (advancedCount >= intermediateCount && advancedCount >= basicCount) return 'advanced';
            return 'intermediate';
        }
        
        function updateLevelResult() {
            // ユーザーのレベルを判定
            const level = determineUserLevel();
            const levelMap = {
                basic: { level: 'A1', description: '基礎から始めるレベル（TOEIC 300-600）' },
                intermediate: { level: 'A2', description: '基礎語彙がある程度理解できるレベル（TOEIC 600-750）' },
                advanced: { level: 'B1', description: '日常会話ができるレベル（TOEIC 750点以上）' }
            };
            
            const info = levelMap[level];
            
            // レベル表示を更新
            document.getElementById('user-level').textContent = info.level;
            document.getElementById('level-description').textContent = info.description;
            
            // ステージタイムラインを更新
            updateStageTimeline(info.level);
            
            // 課題・対策・アプローチのカードを生成
            updateChallengeSolutionCards();
        }
        
        function updateStageTimeline(currentLevel) {
            const stages = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const currentIndex = stages.indexOf(currentLevel);
            
            stages.forEach((stage, index) => {
                const stageElement = document.querySelector(`[data-level="${stage}"]`);
                stageElement.classList.remove('passed', 'current');
                
                if (index < currentIndex) {
                    stageElement.classList.add('passed');
                } else if (index === currentIndex) {
                    stageElement.classList.add('current');
                }
            });
        }
        
        function updateSolutionTabs() {
            const tabsContainer = document.getElementById('solution-tabs');
            const contentContainer = document.getElementById('solution-content');
            
            // 選択された内容に基づいてタブを生成
            const tabs = [];
            const contents = {};
            
            if (hasSkillSelection('sound', 'intermediate') || hasSkillSelection('sound', 'advanced')) {
                tabs.push({ id: 'sound', name: '音の対策' });
                contents.sound = [
                    '音を再現できる（発話できる）ことがゴール',
                    '音読/シャドーイング（レベルに合わせた速さ）',
                    '発音矯正トレーニング'
                ];
            }
            
            if (hasSkillSelection('text', 'intermediate') || hasSkillSelection('text', 'advanced') || 
                hasSkillSelection('vocabulary', 'intermediate') || hasSkillSelection('vocabulary', 'advanced')) {
                tabs.push({ id: 'grammar', name: '短い文章と語彙の対策' });
                contents.grammar = [
                    'とにかく英語の文章をクイックに組むこと',
                    '瞬間英作文、カランメソッドなど、英作文系エクササイズ',
                    '語彙力強化トレーニング'
                ];
            }
            
            if (hasSkillSelection('text', 'advanced') || hasSkillSelection('vocabulary', 'advanced')) {
                tabs.push({ id: 'advanced', name: '長い文章と表現の対策' });
                contents.advanced = [
                    'クイックに構造化すること',
                    '文脈に合わせた表現の選定',
                    '長い文章の多聴多読や、会話でフィードバックを受けることが重要'
                ];
            }
            
            // デフォルトタブを追加（選択がない場合）
            if (tabs.length === 0) {
                tabs.push({ id: 'basic', name: '基礎対策' });
                contents.basic = [
                    '音のルール、文章のルール、基本的な単語など、中学/高校のおさらいが中心',
                    '同時に、自己学習の習慣/経験を積むことが重要'
                ];
            }
            
            // タブを生成
            tabsContainer.innerHTML = tabs.map((tab, index) => 
                `<div class="nav-tab ${index === 0 ? 'active' : ''}" onclick="showSolution('${tab.id}')">${tab.name}</div>`
            ).join('');
            
            // 最初のタブの内容を表示
            const firstTabId = tabs[0].id;
            showSolutionContent(firstTabId, contents[firstTabId]);
        }
        
        function showSolution(tabId) {
            // タブの切り替え
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 内容を動的に生成
            const contents = {
                sound: [
                    '音を再現できる（発話できる）ことがゴール',
                    '音読/シャドーイング（レベルに合わせた速さ）',
                    '発音矯正トレーニング'
                ],
                grammar: [
                    'とにかく英語の文章をクイックに組むこと',
                    '瞬間英作文、カランメソッドなど、英作文系エクササイズ',
                    '語彙力強化トレーニング'
                ],
                advanced: [
                    'クイックに構造化すること',
                    '文脈に合わせた表現の選定',
                    '長い文章の多聴多読や、会話でフィードバックを受けることが重要'
                ],
                basic: [
                    '音のルール、文章のルール、基本的な単語など、中学/高校のおさらいが中心',
                    '同時に、自己学習の習慣/経験を積むことが重要'
                ]
            };
            
            showSolutionContent(tabId, contents[tabId] || contents.basic);
        }
        
        function showSolutionContent(tabId, contentList) {
            const contentContainer = document.getElementById('solution-content');
            contentContainer.innerHTML = `<ul>${contentList.map(item => `<li>${item}</li>`).join('')}</ul>`;
        }
        
        function updateUserIssues() {
            const issues = [];
            
            const skillsData = getSelectedSkills();
            
            skillsData.sound.forEach(level => {
                if (level === 'basic') {
                issues.push('基本的な音のルールがわからない');
                } else if (level === 'intermediate') {
                issues.push('音が聞き分けられない、音が回らない');
                } else if (level === 'advanced') {
                issues.push('スピードについていけない、長くなると保持できない');
            }
            });
            
            skillsData.text.forEach(level => {
                if (level === 'basic') {
                issues.push('基本的な文のルール（文法）がわからない');
                } else if (level === 'intermediate') {
                issues.push('文章で理解できない、文を組み立てられない');
                } else if (level === 'advanced') {
                issues.push('情報量が多くなると理解できない/話せない');
            }
            });
            
            skillsData.vocabulary.forEach(level => {
                if (level === 'basic') {
                issues.push('基本的な単語がわからない');
                } else if (level === 'intermediate') {
                issues.push('とっさに簡単な単語が出てこない');
                } else if (level === 'advanced') {
                issues.push('文脈に応じた表現の使い分けができない');
            }
            });
            
            // デフォルトの課題を設定
            if (issues.length === 0) {
                issues.push('音が聞き分けられない、音が回らない');
                issues.push('文章で理解できない、文を組み立てられない');
                issues.push('とっさに簡単な単語が出てこない');
            }
            
            const issuesList = document.getElementById('user-issues');
            issuesList.innerHTML = issues.map(issue => `<li>${issue}</li>`).join('');
        }
        
        function updateSkillsNextButton() {
            const nextBtn = document.getElementById('skills-next-btn');
            // 新しいデータ構造: skill_level 形式のキーをカウント
            const selectedSkills = Object.keys(userSelections).filter(key => 
                key.includes('_') && userSelections[key] && userSelections[key].skill
            );
            const hasSkillSelection = selectedSkills.length > 0;
            
            console.log('=== updateSkillsNextButton ===');
            console.log('Selected skills:', selectedSkills);
            console.log('Has skill selection:', hasSkillSelection);
            console.log('Full userSelections:', userSelections);
            
            // 現在選択されている要素も確認
            const selectedElements = document.querySelectorAll('.difficulty-btn.selected');
            console.log('Selected elements count:', selectedElements.length);
            selectedElements.forEach((el, index) => {
                console.log(`Selected element ${index}:`, el.dataset.skill, el.dataset.level);
            });
            
            if (hasSkillSelection) {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
                console.log('Next button enabled');
            } else {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
                console.log('Next button disabled');
            }
            console.log('=== End updateSkillsNextButton ===');
        }
        
        function showServiceDetail(service) {
            const detailContent = document.getElementById('service-detail-content');
            
            detailContent.innerHTML = `
                <div class="service-header">
                    <div class="service-logo">${service.logo}</div>
                    <div class="service-info">
                        <h2>${service.name}</h2>
                        <div class="service-price">${service.price}</div>
                    </div>
                </div>
                
                <div class="service-details">
                    <div class="detail-section">
                        <h3>学習内容</h3>
                        <ul class="detail-list">
                            ${service.details["学習内容"].map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h3>特徴</h3>
                        <ul class="detail-list">
                            ${service.details["特徴"].map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <div class="cta-section">
                    <h3>このサービスを始める</h3>
                    <p>公式サイトで詳細を確認し、無料体験から始めることをお勧めします。</p>
                </div>
            `;
            
            // 詳細ページに移動
            nextScreen('service-detail');
            
            // URLを保存
            window.currentServiceUrl = service.url;
        }
        
        function visitService() {
            if (window.currentServiceUrl) {
                window.open(window.currentServiceUrl, '_blank');
            }
        }
    </script>
</body>
</html>